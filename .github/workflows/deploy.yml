# =============================================================================
# Wall & Shadow - Firebase Auto-Deploy
# =============================================================================
#
# This workflow automatically deploys Wall & Shadow to Firebase when code is
# pushed to the master branch.
#
# =============================================================================
# SETUP INSTRUCTIONS - Read this before first deployment!
# =============================================================================
#
# You need to configure TWO GitHub secrets for this workflow to work:
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 1. FIREBASE_SERVICE_ACCOUNT (Base64-encoded service account JSON)       â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# This is the Firebase service account credentials that allow GitHub to deploy
# to your Firebase project.
#
# HOW TO GENERATE A NEW SERVICE ACCOUNT KEY:
# -------------------------------------------
# 1. Go to Firebase Console: https://console.firebase.google.com
# 2. Select your project (e.g., "hexland-test-25" or "hexland")
# 3. Click the gear icon (âš™ï¸) â†’ "Project settings"
# 4. Navigate to the "Service Accounts" tab
# 5. Click "Generate New Private Key" button
# 6. Click "Generate Key" to confirm
# 7. A JSON file will download (e.g., "hexland-test-25-firebase-adminsdk-xxxxx.json")
#    âš ï¸  KEEP THIS FILE SECURE - It contains sensitive credentials!
#
# IMPORTANT: Generating a new key does NOT invalidate old keys!
# Old keys remain valid until you explicitly delete them (see management section below).
#
# REQUIRED PERMISSIONS:
# ---------------------
# The service account should have the "Firebase Develop Admin" role, which includes:
# - Firebase Hosting Admin
# - Cloud Functions Developer
# - Firebase Rules Admin
# - Cloud Datastore Index Admin
# - Service Account User
#
# This role is automatically assigned to the default Firebase Admin SDK service account.
#
# HOW TO MANAGE EXISTING KEYS (View, Delete, Check Last Used):
# --------------------------------------------------------------
# âš ï¸  Firebase Console does NOT show existing keys - you must use Google Cloud Console!
#
# 1. Go to Google Cloud Console: https://console.cloud.google.com
# 2. Select your project from the dropdown
# 3. Navigate to: **IAM & Admin** â†’ **Service Accounts**
# 4. You'll see a list of service accounts (may show 10-20 accounts)
# 5. Find your Firebase Admin SDK service account:
#    - Look for email like: firebase-adminsdk-xxxxx@YOUR-PROJECT-ID.iam.gserviceaccount.com
#    - Example: firebase-adminsdk-ab12c@hexland-test-25.iam.gserviceaccount.com
#    - IGNORE other accounts (they're Google-managed internal accounts like gcf-admin-robot)
# 6. **Click the service account email** (not the checkbox)
# 7. Click the **"Keys"** tab at the top
# 8. You'll now see ALL keys for this service account with:
#    - Key ID (unique identifier)
#    - Created date (how you identify which key is which!)
#    - Type (JSON)
#    - Status (Active)
#
# TO DELETE AN OLD KEY:
# ---------------------
# 1. In the Keys tab (see steps above)
# 2. Find the key you want to delete (use Created date to identify)
# 3. Click the â‹® (three-dot menu) for that key
# 4. Click "Delete"
# 5. Confirm deletion
# âš ï¸  Deletion is permanent! Any apps using that key will immediately fail.
#
# TO CHECK WHEN A KEY WAS LAST USED:
# -----------------------------------
# 1. Go to Google Cloud Console: https://console.cloud.google.com
# 2. Navigate to: **Policy Intelligence** â†’ **Policy Analyzer**
# 3. Under "Analyze recent activity," select:
#    "When was the last time this service account key was used?"
# 4. Click "Create query"
# 5. Enter your project name
# 6. Select the keys you want to analyze (up to 10)
# 7. Click "Run query"
# 8. You'll see the last authentication timestamp for each key
# 9. Keys with no recent activity (90+ days) are safe to delete
#
# KEY NAMING LIMITATION:
# ----------------------
# Google Cloud does NOT allow you to name or label keys. You must identify them by:
# - Creation date/timestamp
# - Key ID (first/last few characters)
# - Manual tracking in your own documentation
#
# Tip: When you download a key, immediately rename the file locally:
#   hexland-test-25-firebase-adminsdk-xxxxx-xxxxxxxxxx.json
#   â†’ firebase-adminsdk-github-actions-2024-12-22.json
#
# KEY ROTATION BEST PRACTICE:
# ----------------------------
# 1. Generate new key (Firebase Console)
# 2. Update GitHub secret with new key
# 3. Test deployment with new key
# 4. Delete old key (Google Cloud Console)
# 5. Rotate every 90 days for security
#
# HOW TO ENCODE AND ADD TO GITHUB:
# ---------------------------------
# On Linux/macOS/WSL:
#   1. Open terminal
#   2. Navigate to where you downloaded the JSON file
#   3. Encode it to base64:
#        cat hexland-test-25-firebase-adminsdk-xxxxx.json | base64 -w 0 > encoded.txt
#      (The -w 0 flag prevents line wrapping)
#   4. Copy the contents of encoded.txt
#   5. DELETE the original JSON file and encoded.txt after adding to GitHub
#
# On Windows PowerShell:
#   1. Open PowerShell
#   2. Navigate to where you downloaded the JSON file
#   3. Encode it to base64:
#        [Convert]::ToBase64String([IO.File]::ReadAllBytes("hexland-test-25-firebase-adminsdk-xxxxx.json")) | Out-File -Encoding ASCII encoded.txt
#   4. Copy the contents of encoded.txt
#   5. DELETE the original JSON file and encoded.txt after adding to GitHub
#
# ADD TO GITHUB SECRETS (Via Web Interface):
#   1. Go to your GitHub repository
#   2. Click "Settings" tab
#   3. In left sidebar: "Secrets and variables" â†’ "Actions"
#   4. Click "New repository secret"
#   5. Name: FIREBASE_SERVICE_ACCOUNT
#   6. Value: Paste the base64-encoded string (the contents of encoded.txt)
#   7. Click "Add secret"
#
# ADD TO GITHUB SECRETS (Via GitHub CLI):
#   gh secret set FIREBASE_SERVICE_ACCOUNT < encoded.txt
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 2. FIREBASE_PROJECT_ID (Your Firebase project ID)                       â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# This is your Firebase project ID (e.g., "hexland-test-25" for test/staging,
# or "hexland" for production).
#
# HOW TO FIND YOUR PROJECT ID:
# -----------------------------
# Option 1: From Firebase Console
#   - Open Firebase Console: https://console.firebase.google.com
#   - Select your project
#   - The project ID is shown under the project name at the top
#
# Option 2: From your local .firebaserc file
#   - Look in hexland-web/.firebaserc
#   - Use one of the project aliases (e.g., "hexland-test-25" or "hexland")
#
# ADD TO GITHUB SECRETS:
#   1. Go to your GitHub repository â†’ Settings â†’ Secrets and variables â†’ Actions
#   2. Click "New repository secret"
#   3. Name: FIREBASE_PROJECT_ID
#   4. Value: Your project ID (e.g., "hexland-test-25")
#   5. Click "Add secret"
#
# =============================================================================
# SECURITY NOTES
# =============================================================================
#
# âœ… DO:
#   - Rotate service account keys every 90 days (regenerate and update secret)
#   - Use separate service accounts for test and production environments
#   - Delete service account keys from your local machine after adding to GitHub
#   - Review GitHub's audit log periodically for secret access
#   - Set up Firebase budget alerts to monitor usage
#
# âŒ DON'T:
#   - Never commit the service account JSON to git (it's in .gitignore)
#   - Don't use the same service account across multiple repositories
#   - Don't share the base64-encoded secret outside of GitHub
#   - Don't grant more permissions than necessary to the service account
#
# =============================================================================
# TRIGGERING DEPLOYMENTS
# =============================================================================
#
# This workflow will automatically run when:
#   - Code is pushed to the master branch
#   - You manually trigger it via GitHub Actions UI (Actions tab â†’ Deploy to Firebase â†’ Run workflow)
#
# To deploy manually without pushing:
#   1. Go to your repository on GitHub
#   2. Click "Actions" tab
#   3. Select "Deploy to Firebase" workflow
#   4. Click "Run workflow" dropdown
#   5. Select branch (usually "master")
#   6. Click "Run workflow"
#
# =============================================================================

name: Deploy to Firebase

on:
  push:
    branches: [master]
  workflow_dispatch:  # Allow manual triggering from GitHub UI

env:
  # Pin firebase-tools version to match development environment
  # Update this when upgrading Firebase CLI
  FIREBASE_TOOLS_VERSION: '15.1.0'

jobs:
  deploy:
    name: Build and Deploy to Firebase
    runs-on: ubuntu-latest

    # Only run on pushes to master or manual triggers
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      # -----------------------------------------------------------------------
      # Checkout code
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Setup Node.js environment
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'
          cache-dependency-path: |
            hexland-web/yarn.lock
            hexland-web/functions/yarn.lock

      # -----------------------------------------------------------------------
      # Install dependencies
      # -----------------------------------------------------------------------
      - name: Install dependencies (web)
        working-directory: hexland-web
        run: yarn install --frozen-lockfile

      - name: Install dependencies (functions)
        working-directory: hexland-web/functions
        run: yarn install --frozen-lockfile

      # -----------------------------------------------------------------------
      # Build Cloud Functions
      # -----------------------------------------------------------------------
      - name: Build Cloud Functions
        working-directory: hexland-web/functions
        run: yarn build

      # -----------------------------------------------------------------------
      # Create mock Firebase credentials for build
      # -----------------------------------------------------------------------
      # The web app looks for firebase-admin-credentials.json during build
      # (there's a symlink in public/ pointing to this file).
      # In production, the app uses Firebase Hosting's auto-config instead.
      # We create a minimal mock file here just to satisfy the build process.
      #
      - name: Create mock Firebase credentials
        working-directory: hexland-web
        run: |
          echo '{"project_id": "demo-project"}' > firebase-admin-credentials.json

      # -----------------------------------------------------------------------
      # Build web application
      # -----------------------------------------------------------------------
      - name: Build web application
        working-directory: hexland-web
        run: yarn build

      # -----------------------------------------------------------------------
      # Decode service account credentials
      # -----------------------------------------------------------------------
      # The service account JSON is stored as a base64-encoded GitHub secret
      # to avoid issues with special characters and secret redaction in logs.
      # We decode it here and write to a temporary file that Firebase CLI can use.
      #
      - name: Decode Firebase service account
        working-directory: hexland-web
        run: |
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" | base64 --decode > firebase-service-account.json
          echo "âœ… Service account credentials decoded"

      # -----------------------------------------------------------------------
      # Deploy to Firebase
      # -----------------------------------------------------------------------
      # This uses the w9jds/firebase-action to deploy all Firebase services:
      #   - Hosting (web app)
      #   - Cloud Functions
      #   - Firestore security rules
      #   - Firestore indexes
      #   - Storage security rules
      #
      # The GOOGLE_APPLICATION_CREDENTIALS environment variable tells Firebase
      # CLI where to find the service account credentials.
      #
      - name: Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --project ${{ secrets.FIREBASE_PROJECT_ID }}
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/hexland-web/firebase-service-account.json

      # -----------------------------------------------------------------------
      # Cleanup
      # -----------------------------------------------------------------------
      # Remove the decoded service account file for security
      # (GitHub Actions runners are ephemeral, but good practice)
      #
      - name: Cleanup credentials
        if: always()
        working-directory: hexland-web
        run: |
          if [ -f firebase-service-account.json ]; then
            rm firebase-service-account.json
            echo "âœ… Credentials cleaned up"
          fi

      # -----------------------------------------------------------------------
      # Deployment complete
      # -----------------------------------------------------------------------
      - name: Deployment summary
        if: success()
        run: |
          echo "ðŸš€ Deployment successful!"
          echo ""
          echo "Your app should be live at:"
          echo "  https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app"
          echo "  https://${{ secrets.FIREBASE_PROJECT_ID }}.firebaseapp.com"
          echo ""
          echo "Deployed services:"
          echo "  âœ… Firebase Hosting"
          echo "  âœ… Cloud Functions"
          echo "  âœ… Firestore Rules"
          echo "  âœ… Firestore Indexes"
          echo "  âœ… Storage Rules"
