version: '3.8'

services:
  hexland-dev:
    build:
      context: .
      dockerfile: Dockerfile

    volumes:
      # Bind mount to workspace
      # Performance: Excellent on Linux and WSL2 (when repo is in WSL filesystem)
      # All cache and config data stored via symlinks (see post-create.sh)
      - ..:/workspaces/hexland

    environment:
      # Critical: webpack 4 compatibility with Node 20
      - NODE_OPTIONS=--openssl-legacy-provider
      # Enable emulator-only functions
      - IS_LOCAL_DEV=true
      # Colorized output in logs
      - FORCE_COLOR=true
      # Firebase admin credentials path (if file exists)
      - GOOGLE_APPLICATION_CREDENTIALS=/workspaces/hexland/hexland-web/firebase-admin-credentials.json

    ports:
      - "3400:3400"  # Firebase Hosting emulator
      - "4000:4000"  # Firebase Emulator UI
      - "5000:5000"  # React dev server
      - "5001:5001"  # Firebase Functions emulator
      - "8080:8080"  # Firestore emulator
      - "9005:9005"  # Firestore debug port
      - "9099:9099"  # Firebase Auth emulator
      - "9229:9229"  # Node.js debug port for Functions

    networks:
      - hexland-network

    # Keep container running
    command: sleep infinity

    # Run as node user (simpler permissions model)
    user: node

  # NVIDIA GPU variant (for WSL2 + Docker Desktop)
  # Activate with: COMPOSE_PROFILES=nvidia or create .env file
  hexland-dev-nvidia:
    extends:
      service: hexland-dev
    profiles: ["nvidia"]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # AMD GPU variant (for native Linux with ROCm)
  # Activate with: COMPOSE_PROFILES=amd or create .env file
  hexland-dev-amd:
    extends:
      service: hexland-dev
    profiles: ["amd"]
    devices:
      - /dev/dri:/dev/dri
      - /dev/kfd:/dev/kfd
    security_opt:
      - seccomp=unconfined
    group_add:
      - video
      - render

  mock-storage:
    build:
      context: ../mock-storage
      dockerfile: Dockerfile

    ports:
      - "7000:80"  # WebDAV storage service

    networks:
      - hexland-network

networks:
  hexland-network:
    driver: bridge
