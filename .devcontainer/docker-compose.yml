version: "3.8"

# Extension field (not a service) - provides common configuration via YAML anchor
x-was-common: &was-common
  build:
    context: .
    dockerfile: Dockerfile

  volumes:
    # Bind mount to workspace
    # Performance: Excellent on Linux and WSL2 (when repo is in WSL filesystem)
    # All cache and config data stored via symlinks (see post-create.sh)
    - ..:/workspaces/wallandshadow

  environment:
    # Enable emulator-only functions
    - IS_LOCAL_DEV=true
    # Colorized output in logs
    - FORCE_COLOR=true
    # Firebase admin credentials path (if file exists)
    - GOOGLE_APPLICATION_CREDENTIALS=/workspaces/wallandshadow/was-web/firebase-admin-credentials.json

  ports:
    - "3400:3400" # Firebase Hosting emulator
    - "4000:4000" # Firebase Emulator UI
    - "5000:5000" # React dev server
    - "5001:5001" # Firebase Functions emulator
    - "8080:8080" # Firestore emulator
    - "9005:9005" # Firestore debug port
    - "9099:9099" # Firebase Auth emulator
    - "9199:9199" # Firebase Storage emulator
    - "9229:9229" # Node.js debug port for Functions
    - "9323:9323" # Playwright test results

  networks:
    - was-network

  # Use host IPC namespace for shared memory (fixes WebGL rendering in Docker)
  ipc: host

  # Keep container running
  command: sleep infinity

  # Run as node user (simpler permissions model)
  user: node

services:
  # No GPU variant (default)
  # Starts when no .env file exists (empty profile activates by default)
  was-dev:
    <<: *was-common
    profiles: ["", "default"]

  # NVIDIA GPU variant
  # Activate by creating .devcontainer/.env with: COMPOSE_PROFILES=nvidia
  was-dev-nvidia:
    <<: *was-common
    profiles: ["nvidia"]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # AMD GPU variant
  # Activate by creating .devcontainer/.env with: COMPOSE_PROFILES=amd
  was-dev-amd:
    <<: *was-common
    profiles: ["amd"]
    devices:
      - /dev/dri:/dev/dri
      - /dev/kfd:/dev/kfd
    security_opt:
      - seccomp=unconfined
    group_add:
      - video
      - render

networks:
  was-network:
    driver: bridge
